image: ghcr.io/cirruslabs/flutter:3.35.1

stages:
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  # These should be defined as GitLab protected variables in the project settings
  KEYSTORE_PASSWORD: $KEYSTORE_PASSWORD
  KEY_PASSWORD: $KEY_PASSWORD
  KEY_ALIAS: $KEY_ALIAS
  # Base64 encoded keystore content
  KEYSTORE_BASE64: $KEYSTORE_BASE64

cache:
  key:
    files:
      - pubspec.lock
  paths:
    - .pub-cache
    - build/
    - .npm/

before_script:
  - flutter pub get
  - flutter --version
  - flutter doctor
  - node --version || (curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - && apt-get install -y nodejs)
  - npm install -g firebase-tools
  - echo "$KEYSTORE_BASE64" | base64 -d > ./my-release-key.keystore
  - echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD"
  - echo -e "storePassword=$KEYSTORE_PASSWORD\nkeyPassword=$KEY_PASSWORD\nkeyAlias=$KEY_ALIAS\nstoreFile=$(pwd)/my-release-key.keystore" > android/key.properties
  - echo "KEY_PASSWORD=$KEY_PASSWORD"
  - echo "KEY_ALIAS=$KEY_ALIAS"
  - ls -l android/
  - cat android/key.properties


build_and_package:
  stage: build
  script:
    - echo "$MY_ENV_FILE" > .env
    - flutter build apk --release
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-release.apk
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy_apk:
  stage: deploy
  script:
    - echo "$FIREBASE_CREDENTIALS" > firebase_credentials.json
    - export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/firebase_credentials.json"
    - firebase appdistribution:distribute build/app/outputs/flutter-apk/app-release.apk --app "1:759335379864:android:6bed5dad18690c487401ed" --groups "Team" --release-notes "ðŸš€ New release from GitLab CI/CD"

  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
